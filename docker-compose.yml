services:
  api-gateway:
    build:
      context: ./services/api-gateway
    ports:
      - "9000:8080"
    environment:
      - SERVICE_NAME=api-gateway
      - PORT=8080
  identity:
    build:
      context: ./services/identity
    ports:
      - "9001:8080"
    environment:
      - SERVICE_NAME=identity
      - PORT=8080
  seller:
    build:
      context: ./services/seller
    ports:
      - "9002:8080"
    environment:
      - SERVICE_NAME=seller
      - PORT=8080
  catalog:
    build:
      context: ./services/catalog
    ports:
      - "9003:8080"
    environment:
      - SERVICE_NAME=catalog
      - PORT=8080
  search:
    build:
      context: ./services/search
    ports:
      - "9004:8080"
    environment:
      - SERVICE_NAME=search
      - PORT=8080
  pricing:
    build:
      context: ./services/pricing
    ports:
      - "9005:8080"
    environment:
      - SERVICE_NAME=pricing
      - PORT=8080
  inventory:
    build:
      context: ./services/inventory
    ports:
      - "9006:8080"
    environment:
      - SERVICE_NAME=inventory
      - PORT=8080
  cart:
    build:
      context: ./services/cart
    ports:
      - "9007:8080"
    environment:
      - SERVICE_NAME=cart
      - PORT=8080
  checkout:
    build:
      context: ./services/checkout
    ports:
      - "9008:8080"
    environment:
      - SERVICE_NAME=checkout
      - PORT=8080
  payments:
    build:
      context: ./services/payments
    ports:
      - "9009:8080"
    environment:
      - SERVICE_NAME=payments
      - PORT=8080
  orders:
    build:
      context: ./services/orders
    ports:
      - "9010:8080"
    environment:
      - SERVICE_NAME=orders
      - PORT=8080
  fulfillment:
    build:
      context: ./services/fulfillment
    ports:
      - "9011:8080"
    environment:
      - SERVICE_NAME=fulfillment
      - PORT=8080
  notifications:
    build:
      context: ./services/notifications
    ports:
      - "9012:8080"
    environment:
      - SERVICE_NAME=notifications
      - PORT=8080
  reviews:
    build:
      context: ./services/reviews
    ports:
      - "9013:8080"
    environment:
      - SERVICE_NAME=reviews
      - PORT=8080
  analytics:
    build:
      context: ./services/analytics
    ports:
      - "9014:8080"
    environment:
      - SERVICE_NAME=analytics
      - PORT=8080
  transformer-api:
    build:
      context: ./services/transformer-api
    ports:
      - "9017:8080"
    environment:
      - SERVICE_NAME=transformer-api
      - PORT=8080
      - BASE_MODEL=distilbert-base-uncased-finetuned-sst-2-english
      - MODEL_DIR=/models/transformer
  postgres:
    image: debezium/postgres:15
    container_name: postgres
    environment:
      - POSTGRES_USER=market
      - POSTGRES_PASSWORD=marketpass
      - POSTGRES_DB=market
    ports:
      - "15432:5432"
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6380:6379"
  opensearch:
    image: opensearchproject/opensearch:latest
    container_name: opensearch
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=Gmp!2026StrongPwd
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: redpanda
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - 1G
      - --reserve-memory
      - 0M
      - --node-id
      - "0"
      - --check=false
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:9092
    ports:
      - "19092:9092"
  kafka-connect:
    image: confluentinc/cp-kafka-connect:7.5.3
    container_name: kafka-connect
    environment:
      - CONNECT_BOOTSTRAP_SERVERS=redpanda:9092
      - CONNECT_GROUP_ID=connect-cluster
      - CONNECT_CONFIG_STORAGE_TOPIC=connect.configs
      - CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR=1
      - CONNECT_OFFSET_STORAGE_TOPIC=connect.offsets
      - CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR=1
      - CONNECT_STATUS_STORAGE_TOPIC=connect.status
      - CONNECT_STATUS_STORAGE_REPLICATION_FACTOR=1
      - CONNECT_KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter
      - CONNECT_VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter
      - CONNECT_INTERNAL_KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter
      - CONNECT_INTERNAL_VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter
      - CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE=false
      - CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE=false
      - CONNECT_REST_ADVERTISED_HOST_NAME=kafka-connect
      - CONNECT_REST_PORT=8083
      - CONNECT_LISTENERS=http://0.0.0.0:8083
      - CONNECT_PLUGIN_DISCOVERY=only_scan
      - CONNECT_PLUGIN_PATH=/usr/share/java/debezium,/usr/share/confluent-hub-components
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=adminadmin
      - S3_ENDPOINT=http://minio:9000
    ports:
      - "8083:8083"
    depends_on:
      - redpanda
      - minio
    volumes:
      - kafka-connect-plugins:/usr/share/confluent-hub-components
    command: >
      bash -lc
      "confluent-hub install confluentinc/kafka-connect-s3:10.5.7 --no-prompt &&
       confluent-hub install debezium/debezium-connector-postgresql:latest --no-prompt &&
       mkdir -p /usr/share/java/debezium &&
       cp -f /usr/share/confluent-hub-components/debezium-debezium-connector-postgresql/lib/*.jar /usr/share/java/debezium/ &&
       echo 'plugin.discovery=only_scan' >> /etc/kafka/connect-distributed.properties &&
       /etc/confluent/docker/run"
  topic-init:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: topic-init
    depends_on:
      - redpanda
    entrypoint: ["/bin/bash","-lc"]
    command:
      - >
        sleep 10 && \
        rpk topic create orders.events -p 3 -r 1 -X brokers=redpanda:9092 || true && \
        rpk topic create payments.events -p 3 -r 1 -X brokers=redpanda:9092 || true && \
        rpk topic create inventory.cdc -p 3 -r 1 -X brokers=redpanda:9092 || true
  debezium-register:
    image: curlimages/curl:8.5.0
    container_name: debezium-register
    depends_on:
      - kafka-connect
      - postgres
    volumes:
      - ./infra/dev/debezium-connector.json:/config/debezium-connector.json:ro
    entrypoint: ["/bin/sh","-lc"]
    command:
      - >
        sleep 40 &&
        curl -s -X POST -H "Content-Type: application/json" --data @/config/debezium-connector.json http://kafka-connect:8083/connectors ||
        curl -s -X PUT -H "Content-Type: application/json" --data @/config/debezium-connector.json http://kafka-connect:8083/connectors/inventory-postgres-connector/config
  minio:
    image: minio/minio:latest
    container_name: minio
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=adminadmin
    command: server /data --console-address ":9001"
    ports:
      - "9015:9000"
      - "9016:9001"
  minio-setup:
    image: minio/mc:latest
    container_name: minio-setup
    depends_on:
      - minio
    entrypoint: ["/bin/sh","-lc"]
    command:
      - >
        sleep 5 &&
        mc alias set local http://minio:9000 admin adminadmin &&
        mc mb -p local/events || true &&
        mc anonymous set download local/events
  s3-sink-register:
    image: curlimages/curl:8.5.0
    container_name: s3-sink-register
    depends_on:
      - kafka-connect
      - minio-setup
    volumes:
      - ./infra/dev/s3-sink-connector.json:/config/s3-sink-connector.json:ro
    entrypoint: ["/bin/sh","-lc"]
    command:
      - >
        sleep 60 &&
        curl -s -X POST -H "Content-Type: application/json" --data @/config/s3-sink-connector.json http://kafka-connect:8083/connectors ||
        curl -s -X PUT -H "Content-Type: application/json" --data @/config/s3-sink-connector.json http://kafka-connect:8083/connectors/s3-sink/config
  web:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      - NEXT_PUBLIC_API_BASE_URL=http://host.docker.internal:9000
      - NODE_ENV=production
    ports:
      - "3000:3000"
    restart: unless-stopped
  web-dev:
    image: node:20-alpine
    working_dir: /app
    environment:
      - NEXT_PUBLIC_API_BASE_URL=http://host.docker.internal:9000
      - NODE_ENV=development
    volumes:
      - ./frontend:/app
      - ./frontend/node_modules:/app/node_modules
    command: sh -lc "npm run dev"
    ports:
      - "3000:3000"
    restart: unless-stopped
volumes:
  kafka-connect-plugins:
